---
import BaseLayout from '@layouts/BaseLayout.astro';
import BlogPostCard from '@components/BlogPostCard.astro';
import { getCollection } from 'astro:content';
import { getReadingTime } from '@utils/readingTime';

export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data }) => !data.draft);

  // Get all unique tags
  const tags = [...new Set(posts.flatMap((post) => post.data.tags))];

  return tags.map((tag) => ({
    params: { tag: tag.toLowerCase() },
    props: {
      tag,
      posts: posts
        .filter((post) =>
          post.data.tags.map((t) => t.toLowerCase()).includes(tag.toLowerCase())
        )
        .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()),
    },
  }));
}

const { tag, posts } = Astro.props;

// Get all unique tags for the filter
const allPosts = await getCollection('blog', ({ data }) => !data.draft);
const allTags = [...new Set(allPosts.flatMap((post) => post.data.tags))].sort();
---

<BaseLayout
  title={`Posts tagged "${tag}"`}
  description={`Articles about ${tag} - React Native, mobile development, and more.`}
>
  <!-- Page Header -->
  <section class="py-12 sm:py-16">
    <div class="animate-in">
      <a
        href="/blog"
        class="inline-flex items-center text-sm text-neutral-500 hover:text-neutral-700 mb-4"
      >
        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        All posts
      </a>
      <h1 class="text-4xl sm:text-5xl font-bold text-neutral-900 mb-6 tracking-tight">
        #{tag}
      </h1>
      <p class="text-xl text-neutral-600">
        {posts.length} {posts.length === 1 ? 'post' : 'posts'} tagged with "{tag}"
      </p>
    </div>
  </section>

  <!-- Tags Filter -->
  <section class="pb-8 animate-in delay-1">
    <div class="flex flex-wrap gap-2">
      <a
        href="/blog"
        class="px-3 py-1.5 text-sm font-medium bg-neutral-100 text-neutral-700 rounded-full hover:bg-neutral-200 transition-colors duration-200"
      >
        All Posts
      </a>
      {allTags.map((t) => (
        <a
          href={`/blog/tag/${t.toLowerCase()}`}
          class:list={[
            'px-3 py-1.5 text-sm font-medium rounded-full transition-colors duration-200',
            t.toLowerCase() === tag.toLowerCase()
              ? 'bg-primary-100 text-primary-700'
              : 'bg-neutral-100 text-neutral-700 hover:bg-neutral-200',
          ]}
        >
          #{t}
        </a>
      ))}
    </div>
  </section>

  <!-- Blog Posts -->
  <section class="py-8 border-t border-neutral-200">
    <div class="animate-in delay-2">
      {posts.length > 0 ? (
        <div class="divide-y divide-neutral-100">
          {posts.map((post) => (
            <BlogPostCard
              title={post.data.title}
              description={post.data.description}
              href={`/blog/${post.id}`}
              pubDate={post.data.pubDate}
              tags={post.data.tags}
              readingTime={getReadingTime(post.body || '')}
            />
          ))}
        </div>
      ) : (
        <div class="text-center py-12">
          <p class="text-neutral-500 mb-4">No posts with this tag yet.</p>
          <a href="/blog" class="text-primary-600 hover:text-primary-700 font-medium">
            ‚Üê View all posts
          </a>
        </div>
      )}
    </div>
  </section>
</BaseLayout>
